<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrabble Detection Accuracy Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            min-height: 100vh;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #00d4ff;
        }
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .card {
            background: #16213e;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid #0f3460;
        }
        .card h3 {
            color: #888;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        .card .value {
            font-size: 36px;
            font-weight: bold;
            color: #00d4ff;
        }
        .card .delta {
            font-size: 14px;
            margin-top: 5px;
        }
        .delta.positive { color: #4ade80; }
        .delta.negative { color: #f87171; }
        .delta.neutral { color: #888; }
        
        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-container {
            background: #16213e;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #0f3460;
        }
        .chart-container h2 {
            color: #00d4ff;
            font-size: 16px;
            margin-bottom: 15px;
        }
        .chart-wrapper {
            height: 300px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: #16213e;
            border-radius: 10px;
            overflow: hidden;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #0f3460;
        }
        th {
            background: #0f3460;
            color: #00d4ff;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
        }
        tr:hover {
            background: #1e3a5f;
        }
        .accuracy-cell {
            font-weight: bold;
        }
        .high { color: #4ade80; }
        .medium { color: #fbbf24; }
        .low { color: #f87171; }
        
        .section-title {
            color: #00d4ff;
            margin: 30px 0 15px;
            font-size: 18px;
        }
        
        .timestamp {
            color: #666;
            font-size: 11px;
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #00d4ff;
            color: #1a1a2e;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }
        .refresh-btn:hover {
            background: #00b8e6;
        }
        
        @media (max-width: 900px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <h1>üéØ Scrabble Detection Accuracy Dashboard</h1>
        
        <div class="summary-cards" id="summaryCards">
            <!-- Filled by JS -->
        </div>
        
        <h2 class="section-title">üèÉ Latest Run</h2>
        <div id="runSelector" style="margin-bottom: 15px;">
            <select id="runIdSelect" style="background: #16213e; color: #eee; border: 1px solid #0f3460; padding: 8px 15px; border-radius: 5px; font-size: 14px;">
                <option value="">Select a run...</option>
            </select>
        </div>
        <table id="runTable">
            <thead>
                <tr>
                    <th>Test</th>
                    <th>Overall</th>
                    <th>Cell F1</th>
                    <th>OCR</th>
                    <th>Precision</th>
                    <th>Recall</th>
                    <th>Transient FP</th>
                    <th>Tiles</th>
                </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
                <tr style="background: #0f3460; font-weight: bold;">
                    <td>AVERAGE</td>
                    <td id="runAvgOverall">-</td>
                    <td id="runAvgF1">-</td>
                    <td id="runAvgOCR">-</td>
                    <td id="runAvgPrecision">-</td>
                    <td id="runAvgRecall">-</td>
                    <td id="runTotalFP">-</td>
                    <td id="runTotalTiles">-</td>
                </tr>
            </tfoot>
        </table>
        
        <div class="charts-row" style="margin-top: 30px;">
            <div class="chart-container">
                <h2>üìà Overall Accuracy by Run</h2>
                <div class="chart-wrapper">
                    <canvas id="accuracyChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <h2>üö´ False Detections by Run</h2>
                <div class="chart-wrapper">
                    <canvas id="falsePositivesChart"></canvas>
                </div>
            </div>
        </div>
        
        <h2 class="section-title">üìú Full History</h2>
        <table id="historyTable">
            <thead>
                <tr>
                    <th>Test</th>
                    <th>Run ID</th>
                    <th>Overall</th>
                    <th>Cell F1</th>
                    <th>OCR</th>
                    <th>Precision</th>
                    <th>Recall</th>
                    <th>Transient FP</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    
    <button class="refresh-btn" onclick="loadData()">üîÑ Refresh</button>
    
    <!-- Fallback: embed data directly if fetch fails -->
    <script id="embedded-data" type="application/json">
    </script>
    
    <script>
        let accuracyChart = null;
        let fpChart = null;
        
        function formatDate(isoString) {
            const d = new Date(isoString);
            return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        function getAccuracyClass(value) {
            if (value >= 90) return 'high';
            if (value >= 70) return 'medium';
            return 'low';
        }
        
        function calculateDelta(current, previous) {
            if (previous === undefined) return { value: 0, class: 'neutral' };
            const delta = current - previous;
            return {
                value: delta,
                class: delta > 0 ? 'positive' : delta < 0 ? 'negative' : 'neutral',
                text: delta > 0 ? `+${delta.toFixed(1)}%` : delta < 0 ? `${delta.toFixed(1)}%` : '‚Äî'
            };
        }
        
        async function loadData() {
            try {
                // Try fetch first (works with local server)
                const response = await fetch('accuracy_results.json?' + Date.now());
                if (!response.ok) throw new Error('Fetch failed');
                const data = await response.json();
                renderDashboard(data);
            } catch (e) {
                console.log('Fetch failed, trying embedded data or prompting user...');
                
                // Check for embedded data
                const embedded = document.getElementById('embedded-data').textContent.trim();
                if (embedded && embedded.length > 10) {
                    try {
                        const data = JSON.parse(embedded);
                        renderDashboard(data);
                        return;
                    } catch (e2) {
                        console.log('Embedded data parse failed');
                    }
                }
                
                // Show file picker UI
                showFilePickerUI();
            }
        }
        
        function showFilePickerUI() {
            const dashboard = document.querySelector('.dashboard');
            dashboard.innerHTML = `
                <h1>üéØ Scrabble Detection Accuracy Dashboard</h1>
                <div style="text-align: center; padding: 50px;">
                    <p style="color: #888; margin-bottom: 20px;">
                        Unable to load data automatically due to browser security.<br>
                        Please select the <code>accuracy_results.json</code> file:
                    </p>
                    <input type="file" id="fileInput" accept=".json" style="display: none;">
                    <button onclick="document.getElementById('fileInput').click()" 
                            style="background: #00d4ff; color: #1a1a2e; border: none; padding: 15px 30px; 
                                   border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold;">
                        üìÅ Select accuracy_results.json
                    </button>
                    <p style="color: #666; margin-top: 30px; font-size: 12px;">
                        Alternatively, run a local server:<br>
                        <code style="background: #0f3460; padding: 5px 10px; border-radius: 5px;">
                            cd tests && python -m http.server 8080
                        </code><br>
                        Then visit <a href="http://localhost:8080/accuracy_dashboard.html" style="color: #00d4ff;">
                            http://localhost:8080/accuracy_dashboard.html
                        </a>
                    </p>
                </div>
            `;
            
            document.getElementById('fileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const data = JSON.parse(event.target.result);
                            // Restore dashboard structure
                            location.reload();
                            // Store in sessionStorage for reload
                            sessionStorage.setItem('accuracyData', event.target.result);
                        } catch (err) {
                            alert('Invalid JSON file');
                        }
                    };
                    reader.readAsText(file);
                }
            });
            
            // Check sessionStorage for previously loaded data
            const stored = sessionStorage.getItem('accuracyData');
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    // Re-render with stored data
                    document.querySelector('.dashboard').innerHTML = `
                        <h1>üéØ Scrabble Detection Accuracy Dashboard</h1>
                        <div class="summary-cards" id="summaryCards"></div>
                        <div class="charts-row">
                            <div class="chart-container">
                                <h2>üìà Overall Accuracy Over Time</h2>
                                <div class="chart-wrapper"><canvas id="accuracyChart"></canvas></div>
                            </div>
                            <div class="chart-container">
                                <h2>üö´ False Detections Over Time</h2>
                                <div class="chart-wrapper"><canvas id="falsePositivesChart"></canvas></div>
                            </div>
                        </div>
                        <h2 class="section-title">üìä Per-Test Results (Latest)</h2>
                        <table id="latestTable"><thead><tr>
                            <th>Test</th><th>Overall</th><th>Cell F1</th><th>OCR</th>
                            <th>Tiles</th><th>False Detections</th><th>Removed</th><th>Timestamp</th>
                        </tr></thead><tbody></tbody></table>
                        <h2 class="section-title">üìú Full History</h2>
                        <table id="historyTable"><thead><tr>
                            <th>Test</th><th>Run #</th><th>Overall</th><th>Cell F1</th><th>OCR</th>
                            <th>Precision</th><th>Recall</th><th>Transient FP</th><th>Timestamp</th>
                        </tr></thead><tbody></tbody></table>
                    `;
                    renderDashboard(data);
                } catch (e) {
                    sessionStorage.removeItem('accuracyData');
                }
            }
        }
        
        function renderDashboard(data) {
            const testNames = Object.keys(data).sort();
            
            // Calculate aggregates
            let totalLatestAccuracy = 0;
            let totalPrevAccuracy = 0;
            let totalLatestFP = 0;
            let totalPrevFP = 0;
            let latestCount = 0;
            let prevCount = 0;
            
            testNames.forEach(test => {
                const results = data[test];
                if (results.length > 0) {
                    totalLatestAccuracy += results[results.length - 1].overall_accuracy;
                    totalLatestFP += results[results.length - 1].transient_false_positives || 0;
                    latestCount++;
                }
                if (results.length > 1) {
                    totalPrevAccuracy += results[results.length - 2].overall_accuracy;
                    totalPrevFP += results[results.length - 2].transient_false_positives || 0;
                    prevCount++;
                }
            });
            
            const avgLatest = latestCount > 0 ? totalLatestAccuracy / latestCount : 0;
            const avgPrev = prevCount > 0 ? totalPrevAccuracy / prevCount : avgLatest;
            const accDelta = calculateDelta(avgLatest, avgPrev);
            
            const fpDelta = calculateDelta(totalLatestFP, totalPrevFP);
            fpDelta.class = fpDelta.value < 0 ? 'positive' : fpDelta.value > 0 ? 'negative' : 'neutral';
            fpDelta.text = fpDelta.value > 0 ? `+${fpDelta.value}` : fpDelta.value < 0 ? `${fpDelta.value}` : '‚Äî';
            
            // Summary cards
            document.getElementById('summaryCards').innerHTML = `
                <div class="card">
                    <h3>Average Accuracy</h3>
                    <div class="value">${avgLatest.toFixed(1)}%</div>
                    <div class="delta ${accDelta.class}">${accDelta.text}</div>
                </div>
                <div class="card">
                    <h3>Total Tests</h3>
                    <div class="value">${testNames.length}</div>
                </div>
                <div class="card">
                    <h3>Total False Detections</h3>
                    <div class="value">${totalLatestFP}</div>
                    <div class="delta ${fpDelta.class}">${fpDelta.text}</div>
                </div>
                <div class="card">
                    <h3>Total Runs</h3>
                    <div class="value">${testNames.reduce((sum, t) => sum + data[t].length, 0)}</div>
                </div>
            `;
            
            // Collect all run IDs
            const allRunIds = new Set();
            testNames.forEach(test => {
                data[test].forEach(r => {
                    if (r.run_id) allRunIds.add(r.run_id);
                });
            });
            
            // Populate run selector
            const runSelect = document.getElementById('runIdSelect');
            runSelect.innerHTML = '<option value="">Select a run...</option>';
            Array.from(allRunIds).sort().reverse().forEach(runId => {
                const opt = document.createElement('option');
                opt.value = runId;
                opt.textContent = formatRunId(runId);
                runSelect.appendChild(opt);
            });
            
            // Set up run selector change handler
            runSelect.onchange = () => renderRunTable(data, runSelect.value);
            
            // Auto-select most recent run if available
            if (allRunIds.size > 0) {
                const mostRecent = Array.from(allRunIds).sort().reverse()[0];
                runSelect.value = mostRecent;
                renderRunTable(data, mostRecent);
            }
            
            // History table
            const historyTbody = document.querySelector('#historyTable tbody');
            historyTbody.innerHTML = '';
            testNames.forEach(test => {
                data[test].forEach((r, i) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${test}</td>
                        <td class="timestamp">${r.run_id || '‚Äî'}</td>
                        <td class="accuracy-cell ${getAccuracyClass(r.overall_accuracy)}">${r.overall_accuracy.toFixed(1)}%</td>
                        <td>${r.cell_f1.toFixed(1)}%</td>
                        <td>${r.ocr_accuracy.toFixed(1)}%</td>
                        <td>${r.cell_precision.toFixed(1)}%</td>
                        <td>${r.cell_recall.toFixed(1)}%</td>
                        <td>${r.transient_false_positives || '‚Äî'}</td>
                        <td class="timestamp">${formatDate(r.timestamp)}</td>
                    `;
                    historyTbody.appendChild(row);
                });
            });
            
            // Charts - only show runs with run_id
            renderCharts(data, testNames, Array.from(allRunIds).sort());
        }
        
        function formatRunId(runId) {
            // Convert 20251225-143000 to "Dec 25, 2025 2:30 PM"
            if (!runId || runId.length !== 15) return runId;
            const year = runId.slice(0, 4);
            const month = parseInt(runId.slice(4, 6)) - 1;
            const day = runId.slice(6, 8);
            const hour = runId.slice(9, 11);
            const min = runId.slice(11, 13);
            const sec = runId.slice(13, 15);
            const d = new Date(year, month, day, hour, min, sec);
            return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        function renderRunTable(data, runId) {
            const table = document.getElementById('runTable');
            const tbody = table.querySelector('tbody');
            
            if (!runId) {
                table.style.display = 'none';
                return;
            }
            
            table.style.display = 'table';
            tbody.innerHTML = '';
            
            const testNames = Object.keys(data).sort();
            let totalOverall = 0, totalF1 = 0, totalOCR = 0, totalPrecision = 0, totalRecall = 0;
            let totalFP = 0, totalTiles = 0;
            let count = 0;
            
            testNames.forEach(test => {
                // Find result with matching run_id
                const result = data[test].find(r => r.run_id === runId);
                if (!result) return;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${test}</strong></td>
                    <td class="accuracy-cell ${getAccuracyClass(result.overall_accuracy)}">${result.overall_accuracy.toFixed(1)}%</td>
                    <td>${result.cell_f1.toFixed(1)}%</td>
                    <td>${result.ocr_accuracy.toFixed(1)}%</td>
                    <td>${result.cell_precision.toFixed(1)}%</td>
                    <td>${result.cell_recall.toFixed(1)}%</td>
                    <td class="${(result.transient_false_positives || 0) > 0 ? 'low' : 'high'}">${result.transient_false_positives || 0}</td>
                    <td>${result.expected_tiles}</td>
                `;
                tbody.appendChild(row);
                
                totalOverall += result.overall_accuracy;
                totalF1 += result.cell_f1;
                totalOCR += result.ocr_accuracy;
                totalPrecision += result.cell_precision;
                totalRecall += result.cell_recall;
                totalFP += result.transient_false_positives || 0;
                totalTiles += result.expected_tiles;
                count++;
            });
            
            // Update footer averages
            if (count > 0) {
                document.getElementById('runAvgOverall').textContent = (totalOverall / count).toFixed(1) + '%';
                document.getElementById('runAvgOverall').className = 'accuracy-cell ' + getAccuracyClass(totalOverall / count);
                document.getElementById('runAvgF1').textContent = (totalF1 / count).toFixed(1) + '%';
                document.getElementById('runAvgOCR').textContent = (totalOCR / count).toFixed(1) + '%';
                document.getElementById('runAvgPrecision').textContent = (totalPrecision / count).toFixed(1) + '%';
                document.getElementById('runAvgRecall').textContent = (totalRecall / count).toFixed(1) + '%';
                document.getElementById('runTotalFP').textContent = totalFP;
                document.getElementById('runTotalFP').className = totalFP > 0 ? 'low' : 'high';
                document.getElementById('runTotalTiles').textContent = totalTiles;
            }
        }
        
        function renderCharts(data, testNames, runIds) {
            const colors = ['#00d4ff', '#4ade80', '#fbbf24', '#f87171', '#a78bfa', '#fb923c'];
            
            // Use run IDs as labels (formatted)
            const labels = runIds.map(id => formatRunId(id).split(' ')[0]); // Just date part
            
            // For each test, find data points matching each run ID
            const accDatasets = testNames.map((test, i) => {
                const dataPoints = runIds.map(runId => {
                    const result = data[test].find(r => r.run_id === runId);
                    return result ? result.overall_accuracy : null;
                });
                return {
                    label: test,
                    data: dataPoints,
                    borderColor: colors[i % colors.length],
                    backgroundColor: colors[i % colors.length] + '33',
                    tension: 0.3,
                    fill: false,
                    spanGaps: true
                };
            });
            
            if (accuracyChart) accuracyChart.destroy();
            accuracyChart = new Chart(document.getElementById('accuracyChart'), {
                type: 'line',
                data: { labels, datasets: accDatasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: 0, max: 100, grid: { color: '#333' } },
                        x: { grid: { color: '#333' } }
                    },
                    plugins: { legend: { labels: { color: '#eee' } } }
                }
            });
            
            // False positives chart
            const fpDatasets = testNames.map((test, i) => {
                const dataPoints = runIds.map(runId => {
                    const result = data[test].find(r => r.run_id === runId);
                    return result ? (result.transient_false_positives || 0) : null;
                });
                return {
                    label: test,
                    data: dataPoints,
                    borderColor: colors[i % colors.length],
                    backgroundColor: colors[i % colors.length] + '33',
                    tension: 0.3,
                    fill: false,
                    spanGaps: true
                };
            });
            
            if (fpChart) fpChart.destroy();
            fpChart = new Chart(document.getElementById('falsePositivesChart'), {
                type: 'line',
                data: { labels, datasets: fpDatasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: 0, grid: { color: '#333' } },
                        x: { grid: { color: '#333' } }
                    },
                    plugins: { legend: { labels: { color: '#eee' } } }
                }
            });
        }
        
        // Load on start
        loadData();
    </script>
</body>
</html>
